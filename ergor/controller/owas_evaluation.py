def evaluate_owas(posture_frequencies, load_weight):
    """
    Evalúa las posturas corporales utilizando el método OWAS.
    :param angles: Diccionario con ángulos corporales promedio.
    :param load_weight: Peso de la carga manejada (en kg).
    :return: Diccionario con categorías OWAS para espalda, brazos, piernas y carga.
    """

    def get_most_frequent_category(frequencies):
        """ Devuelve la categoría más frecuente en base a las observaciones. """
        return max(frequencies, key=frequencies.get, default=1)

    # Determinar categoría de espalda, brazos y piernas basados en frecuencia
    back_category = get_most_frequent_category(posture_frequencies["back"])
    arms_category = get_most_frequent_category(posture_frequencies["arms"])
    legs_category = get_most_frequent_category(posture_frequencies["legs"])

    # Clasificación de carga
    if load_weight < 10:
        load_code = 1
    elif 10 <= load_weight <= 20:
        load_code = 2
    else:
        load_code = 3

        
    risk_table = {
        # Espalda 1 (Derecha)
        (1, 1, 1, 1): 1, (1, 1, 1, 2): 1, (1, 1, 1, 3): 1,
        (1, 1, 2, 1): 1, (1, 1, 2, 2): 1, (1, 1, 2, 3): 1,
        (1, 1, 3, 1): 1, (1, 1, 3, 2): 1, (1, 1, 3, 3): 1,
        (1, 1, 4, 1): 2, (1, 1, 4, 2): 2, (1, 1, 4, 3): 2,
        (1, 1, 5, 1): 2, (1, 1, 5, 2): 2, (1, 1, 5, 3): 2,
        (1, 1, 6, 1): 1, (1, 1, 6, 2): 1, (1, 1, 6, 3): 1,
        (1, 1, 7, 1): 1, (1, 1, 7, 2): 1, (1, 1, 7, 3): 1,

        (1, 2, 1, 1): 1, (1, 2, 1, 2): 1, (1, 2, 1, 3): 1,
        (1, 2, 2, 1): 1, (1, 2, 2, 2): 1, (1, 2, 2, 3): 1,
        (1, 2, 3, 1): 1, (1, 2, 3, 2): 1, (1, 2, 3, 3): 1,
        (1, 2, 4, 1): 2, (1, 2, 4, 2): 2, (1, 2, 4, 3): 2,
        (1, 2, 5, 1): 2, (1, 2, 5, 2): 2, (1, 2, 5, 3): 2,
        (1, 2, 6, 1): 1, (1, 2, 6, 2): 1, (1, 2, 6, 3): 1,
        (1, 2, 7, 1): 1, (1, 2, 7, 2): 1, (1, 2, 7, 3): 1,

        (1, 3, 1, 1): 1, (1, 3, 1, 2): 1, (1, 3, 1, 3): 1,
        (1, 3, 2, 1): 1, (1, 3, 2, 2): 1, (1, 3, 2, 3): 1,
        (1, 3, 3, 1): 1, (1, 3, 3, 2): 1, (1, 3, 3, 3): 2,
        (1, 3, 4, 1): 2, (1, 3, 4, 2): 2, (1, 3, 4, 3): 3,
        (1, 3, 5, 1): 2, (1, 3, 5, 2): 2, (1, 3, 5, 3): 3,
        (1, 3, 6, 1): 1, (1, 3, 6, 2): 1, (1, 3, 6, 3): 2,
        (1, 3, 7, 1): 1, (1, 3, 7, 2): 1, (1, 3, 7, 3): 1,

        # Espalda 2 (Doblada)
        (2, 1, 1, 1): 2, (2, 1, 1, 2): 2, (2, 1, 1, 3): 3,
        (2, 1, 2, 1): 2, (2, 1, 2, 2): 2, (2, 1, 2, 3): 3,
        (2, 1, 3, 1): 2, (2, 1, 3, 2): 2, (2, 1, 3, 3): 3,
        (2, 1, 4, 1): 3, (2, 1, 4, 2): 3, (2, 1, 4, 3): 3,
        (2, 1, 5, 1): 3, (2, 1, 5, 2): 3, (2, 1, 5, 3): 3,
        (2, 1, 6, 1): 2, (2, 1, 6, 2): 2, (2, 1, 6, 3): 3,
        (2, 1, 7, 1): 2, (2, 1, 7, 2): 2, (2, 1, 7, 3): 3,

        (2, 2, 1, 1): 2, (2, 2, 1, 2): 2, (2, 2, 1, 3): 3,
        (2, 2, 2, 1): 2, (2, 2, 2, 2): 2, (2, 2, 2, 3): 3,
        (2, 2, 3, 1): 2, (2, 2, 3, 2): 3, (2, 2, 3, 3): 3,
        (2, 2, 4, 1): 3, (2, 2, 4, 2): 4, (2, 2, 4, 3): 4,
        (2, 2, 5, 1): 3, (2, 2, 5, 2): 4, (2, 2, 5, 3): 3,
        (2, 2, 6, 1): 3, (2, 2, 6, 2): 3, (2, 2, 6, 3): 4,
        (2, 2, 7, 1): 2, (2, 2, 7, 2): 3, (2, 2, 7, 3): 4,

        (2, 3, 1, 1): 3, (2, 3, 1, 2): 3, (2, 3, 1, 3): 4,
        (2, 3, 2, 1): 2, (2, 3, 2, 2): 2, (2, 3, 2, 3): 3,
        (2, 3, 3, 1): 3, (2, 3, 3, 2): 3, (2, 3, 3, 3): 3,
        (2, 3, 4, 1): 4, (2, 3, 4, 2): 4, (2, 3, 4, 3): 4,
        (2, 3, 5, 1): 4, (2, 3, 5, 2): 4, (2, 3, 5, 3): 4,
        (2, 3, 6, 1): 4, (2, 3, 6, 2): 4, (2, 3, 6, 3): 4,
        (2, 3, 7, 1): 2, (2, 3, 7, 2): 3, (2, 3, 7, 3): 4,

        # Espalda 3 (Con giro)
        (3, 1, 1, 1): 1, (3, 1, 1, 2): 1, (3, 1, 1, 3): 2,
        (3, 1, 2, 1): 1, (3, 1, 2, 2): 1, (3, 1, 2, 3): 1,
        (3, 1, 3, 1): 1, (3, 1, 3, 2): 1, (3, 1, 3, 3): 1,
        (3, 1, 4, 1): 3, (3, 1, 4, 2): 3, (3, 1, 4, 3): 3,
        (3, 1, 5, 1): 4, (3, 1, 5, 2): 4, (3, 1, 5, 3): 4,
        (3, 1, 6, 1): 1, (3, 1, 6, 2): 1, (3, 1, 6, 3): 1,
        (3, 1, 7, 1): 1, (3, 1, 7, 2): 1, (3, 1, 7, 3): 1,

        (3, 2, 1, 1): 2, (3, 2, 1, 2): 2, (3, 2, 1, 3): 3,
        (3, 2, 2, 1): 1, (3, 2, 2, 2): 1, (3, 2, 2, 3): 1,
        (3, 2, 3, 1): 1, (3, 2, 3, 2): 1, (3, 2, 3, 3): 2,
        (3, 2, 4, 1): 4, (3, 2, 4, 2): 4, (3, 2, 4, 3): 4,
        (3, 2, 5, 1): 4, (3, 2, 5, 2): 4, (3, 2, 5, 3): 4,
        (3, 2, 6, 1): 3, (3, 2, 6, 2): 3, (3, 2, 6, 3): 3,
        (3, 2, 7, 1): 1, (3, 2, 7, 2): 1, (3, 2, 7, 3): 1,

        (3, 3, 1, 1): 2, (3, 3, 1, 2): 2, (3, 3, 1, 3): 3,
        (3, 3, 2, 1): 1, (3, 3, 2, 2): 1, (3, 3, 2, 3): 1,
        (3, 3, 3, 1): 2, (3, 3, 3, 2): 3, (3, 3, 3, 3): 3,
        (3, 3, 4, 1): 4, (3, 3, 4, 2): 4, (3, 3, 4, 3): 4,
        (3, 3, 5, 1): 4, (3, 3, 5, 2): 4, (3, 3, 5, 3): 4,
        (3, 3, 6, 1): 4, (3, 3, 6, 2): 4, (3, 3, 6, 3): 4,
        (3, 3, 7, 1): 1, (3, 3, 7, 2): 1, (3, 3, 7, 3): 1,

        # Espalda 4 (Doblada con giro)
        (4, 1, 1, 1): 2, (4, 1, 1, 2): 3, (4, 1, 1, 3): 3,
        (4, 1, 2, 1): 2, (4, 1, 2, 2): 2, (4, 1, 2, 3): 3,
        (4, 1, 3, 1): 2, (4, 1, 3, 2): 2, (4, 1, 3, 3): 3,
        (4, 1, 4, 1): 4, (4, 1, 4, 2): 4, (4, 1, 4, 3): 4,
        (4, 1, 5, 1): 4, (4, 1, 5, 2): 4, (4, 1, 5, 3): 4,
        (4, 1, 6, 1): 4, (4, 1, 6, 2): 4, (4, 1, 6, 3): 4,
        (4, 1, 7, 1): 2, (4, 1, 7, 2): 3, (4, 1, 7, 3): 4,

        (4, 2, 1, 1): 3, (4, 2, 1, 2): 3, (4, 2, 1, 3): 4,
        (4, 2, 2, 1): 2, (4, 2, 2, 2): 3, (4, 2, 2, 3): 4,
        (4, 2, 3, 1): 3, (4, 2, 3, 2): 3, (4, 2, 3, 3): 4,
        (4, 2, 4, 1): 4, (4, 2, 4, 2): 4, (4, 2, 4, 3): 4,
        (4, 2, 5, 1): 4, (4, 2, 5, 2): 4, (4, 2, 5, 3): 4,
        (4, 2, 6, 1): 4, (4, 2, 6, 2): 4, (4, 2, 6, 3): 4,
        (4, 2, 7, 1): 2, (4, 2, 7, 2): 3, (4, 2, 7, 3): 4,

        (4, 3, 1, 1): 4, (4, 3, 1, 2): 4, (4, 3, 1, 3): 4,
        (4, 3, 2, 1): 2, (4, 3, 2, 2): 3, (4, 3, 2, 3): 4,
        (4, 3, 3, 1): 3, (4, 3, 3, 2): 3, (4, 3, 3, 3): 4,
        (4, 3, 4, 1): 4, (4, 3, 4, 2): 4, (4, 3, 4, 3): 4,
        (4, 3, 5, 1): 4, (4, 3, 5, 2): 4, (4, 3, 5, 3): 4,
        (4, 3, 6, 1): 4, (4, 3, 6, 2): 4, (4, 3, 6, 3): 4,
        (4, 3, 7, 1): 2, (4, 3, 7, 2): 3, (4, 3, 7, 3): 4,
    }


    # Calcular categoría de acción OWAS
    action_category = risk_table.get((back_category, arms_category, legs_category, load_code), 1)
    
    # Determinar nivel de riesgo global basado en frecuencias
    max_freq = max(
        max(posture_frequencies["back"].values(), default=0),
        max(posture_frequencies["arms"].values(), default=0),
        max(posture_frequencies["legs"].values(), default=0)
    )

    risk_level = "Bajo"
    if max_freq >= 50:
        risk_level = "Moderado"
    if max_freq >= 70:
        risk_level = "Alto"
    if max_freq >= 90:
        risk_level = "Muy Alto"


    return {
        "back_category": back_category,
        "arms_category": arms_category,
        "legs_category": legs_category,
        "load_weight": load_code,
        "action_category": action_category,
        "risk_level": "Bajo" if action_category == 1 else "Moderado" if action_category == 2 else "Alto" if action_category == 3 else "Muy Alto"

    }
